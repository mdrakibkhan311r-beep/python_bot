# -*- coding: utf-8 -*-
import asyncio
import re
import requests
from bs4 import BeautifulSoup
import time
import json
import os
import traceback
from telegram import Bot
from urllib.parse import urljoin
from datetime import datetime, timedelta

YOUR_BOT_TOKEN = "8499892763:AAG9IBLT5OScO7vtfJ89bionjwZbbXC4kso"
YOUR_CHAT_IDS = ["-1002652682061"]

LOGIN_URL = "https://www.ivasms.com/login"
BASE_URL = "https://www.ivasms.com/"
SMS_API_ENDPOINT = "https://www.ivasms.com/portal/sms/received/getsms"

USERNAME = "mdrahatparsonal@gmail.com"
PASSWORD = "Rahat@999"

POLLING_INTERVAL_SECONDS = 0.4
STATE_FILE = "processed_sms_ids_ivasms.json"

COUNTRY_FLAGS = {
    "Afghanistan": "üá¶üá´", "Bangladesh": "üáßüá©", "India": "üáÆüá≥",
    "United States": "üá∫üá∏", "Pakistan": "üáµüá∞", "Nepal": "üá≥üáµ",
    "United Kingdom": "üá¨üáß", "Saudi Arabia": "üá∏üá¶", "TOGO": "üáπüá¨",
    "Unknown Country": "üè¥‚Äç‚ò†Ô∏è"
}

KNOWN_SERVICES = {
    "Telegram": "üì©", "WhatsApp": "üü¢", "Facebook": "üìò", "Instagram": "üì∏", "Messenger": "üí¨",
    "Google": "üîç", "Gmail": "‚úâÔ∏è", "YouTube": "‚ñ∂Ô∏è", "Twitter": "üê¶", "X": "‚ùå",
    "TikTok": "üéµ", "Snapchat": "üëª", "Amazon": "üõí", "eBay": "üì¶", "AliExpress": "üì¶",
    "Alibaba": "üè≠", "Flipkart": "üì¶", "Microsoft": "ü™ü", "Outlook": "üìß", "Skype": "üìû",
    "Netflix": "üé¨", "Spotify": "üé∂", "Apple": "üçè", "iCloud": "‚òÅÔ∏è", "PayPal": "üí∞",
    "Stripe": "üí≥", "Cash App": "üíµ", "Venmo": "üí∏", "Zelle": "üè¶", "Wise": "üåê",
    "Binance": "ü™ô", "Coinbase": "ü™ô", "KuCoin": "ü™ô", "Bybit": "üìà", "OKX": "üü†",
    "Huobi": "üî•", "Kraken": "üêô", "MetaMask": "ü¶ä", "Discord": "üó®Ô∏è", "Steam": "üéÆ",
    "Epic Games": "üïπÔ∏è", "PlayStation": "üéÆ", "Xbox": "üéÆ", "Twitch": "üì∫", "Reddit": "üëΩ",
    "Yahoo": "üü£", "ProtonMail": "üîê", "Zoho": "üì¨", "Quora": "‚ùì", "StackOverflow": "üßë‚Äçüíª",
    "LinkedIn": "üíº", "Indeed": "üìã", "Upwork": "üßë‚Äçüíª", "Fiverr": "üíª", "Glassdoor": "üîé",
    "Airbnb": "üè†", "Booking.com": "üõèÔ∏è", "Uber": "üöó", "Lyft": "üöï", "Bolt": "üöñ",
    "Careem": "üöó", "Swiggy": "üçî", "Zomato": "üçΩÔ∏è", "Foodpanda": "üç±",
    "McDonald's": "üçü", "KFC": "üçó", "Nike": "üëü", "Adidas": "üëü", "Shein": "üëó",
    "OnlyFans": "üîû", "Tinder": "üî•", "Bumble": "üêù", "Grindr": "üòà", "Signal": "üîê",
    "Viber": "üìû", "Line": "üí¨", "WeChat": "üí¨", "VK": "üåê", "Unknown": "‚ùì"
}

def escape_markdown(text):
    escape_chars = r'\\_*[]()~`>#+-=|{}.!'
    return re.sub(f'([{re.escape(escape_chars)}])', r'\\\1', str(text))

def detect_service(sms_text, service_div_text):
    """SMS ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ì ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶°‡¶ø‡¶≠ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶¶‡ßá‡¶ñ‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶Ü‡¶á‡¶ï‡¶® ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßá‡•§"""
    service_text = service_div_text or ""
    # ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶°‡¶ø‡¶≠ ‡¶•‡ßá‡¶ï‡ßá ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶¨ ‡¶∏‡¶®‡¶æ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶§‡ßá
    for svc_name in KNOWN_SERVICES:
        if svc_name.lower() in service_text.lower() or svc_name.lower() in sms_text.lower():
            return svc_name
    return "Unknown"

async def send_telegram_message(bot_token, chat_id, message_data):
    try:
        time_str = message_data.get("time", "N/A")
        number_str = message_data.get("number", "N/A")
        country_name = message_data.get("country", "N/A")
        flag_emoji = message_data.get("flag", "üè¥‚Äç‚ò†Ô∏è")
        service_name = message_data.get("service", "Unknown")
        code_str = message_data.get("code", "N/A")
        full_sms_text = message_data.get("full_sms", "N/A")

        icon = KNOWN_SERVICES.get(service_name, "‚ùì")

        full_message = (
            f"üîî *You have successfully received OTP*\n\n"
            f"üìû *Number:* `{escape_markdown(number_str)}`\n"
            f"üîë *Code:* `{escape_markdown(code_str)}`\n"
            f"üèÜ *Service:* {icon} {escape_markdown(service_name)}\n"
            f"üåé *Country:* {escape_markdown(country_name)} {flag_emoji}\n"
            f"‚è≥ *Time:* `{escape_markdown(time_str)}`\n"
            f"üí¨ *Message:*\n"
            f"```\n{full_sms_text}\n```"
        )
        bot = Bot(token=bot_token)
        await bot.send_message(chat_id=chat_id, text=full_message, parse_mode='MarkdownV2')
    except Exception as e:
        print(f"‚ùå ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶Ü‡¶á‡¶°‡¶ø {chat_id}-‡¶§‡ßá ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: {e}")

def load_processed_ids():
    if not os.path.exists(STATE_FILE): return set()
    try:
        with open(STATE_FILE, 'r') as f: return set(json.load(f))
    except (json.JSONDecodeError, FileNotFoundError): return set()

def save_processed_id(sms_id):
    processed_ids = load_processed_ids()
    processed_ids.add(sms_id)
    with open(STATE_FILE, 'w') as f: json.dump(list(processed_ids), f)

def fetch_sms_from_api(session, headers, csrf_token):
    all_messages = []
    try:
        today = datetime.now()
        start_date = today - timedelta(days=1)
        from_date_str = start_date.strftime('%m/%d/%Y')
        to_date_str = today.strftime('%m/%d/%Y')

        first_payload = {'from': from_date_str, 'to': to_date_str, '_token': csrf_token}
        print("‚ÑπÔ∏è ‡¶ß‡¶æ‡¶™ ‡ßß: SMS ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶Ü‡¶®‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...")
        summary_response = session.post(SMS_API_ENDPOINT, headers=headers, data=first_payload)
        summary_response.raise_for_status()
        summary_soup = BeautifulSoup(summary_response.text, 'html.parser')
        group_divs = summary_soup.find_all('div', {'class': 'pointer'})
        if not group_divs:
            print("‚úîÔ∏è ‡¶ï‡ßã‡¶®‡ßã SMS ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§")
            return []
        group_ids = [re.search(r"getDetials\('(.+?)'\)", div.get('onclick', '')).group(1) for div in group_divs if re.search(r"getDetials\('(.+?)'\)", div.get('onclick', ''))]
        print(f"‚úÖ ‡¶ß‡¶æ‡¶™ ‡ßß ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®‡•§ {len(group_ids)} ‡¶ü‡¶ø ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá‡•§")

        numbers_url = urljoin(BASE_URL, "portal/sms/received/getsms/number")
        sms_url = urljoin(BASE_URL, "portal/sms/received/getsms/number/sms")

        for group_id in group_ids:
            print(f"‚ÑπÔ∏è ‡¶ß‡¶æ‡¶™ ‡ß®: '{group_id}' ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™ ‡¶•‡ßá‡¶ï‡ßá ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶Ü‡¶®‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...")
            numbers_payload = {'start': from_date_str, 'end': to_date_str, 'range': group_id, '_token': csrf_token}
            numbers_response = session.post(numbers_url, headers=headers, data=numbers_payload)
            numbers_soup = BeautifulSoup(numbers_response.text, 'html.parser')
            number_divs = numbers_soup.select("div[onclick*='getDetialsNumber']")
            if not number_divs: continue
            phone_numbers = [div.text.strip() for div in number_divs]
            print(f"‚úÖ '{group_id}' ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™‡ßá {len(phone_numbers)} ‡¶ü‡¶ø ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá‡•§")

            for phone_number in phone_numbers:
                print(f"‚ÑπÔ∏è ‡¶ß‡¶æ‡¶™ ‡ß©: '{phone_number}' ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶•‡ßá‡¶ï‡ßá SMS ‡¶Ü‡¶®‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...")
                sms_payload = {'start': from_date_str, 'end': to_date_str, 'Number': phone_number, 'Range': group_id, '_token': csrf_token}
                sms_response = session.post(sms_url, headers=headers, data=sms_payload)
                sms_soup = BeautifulSoup(sms_response.text, 'html.parser')
                final_sms_cards = sms_soup.find_all('div', class_='card-body')

                for card in final_sms_cards:
                    sms_text_p = card.find('p', class_='mb-0')
                    if sms_text_p:
                        sms_text = sms_text_p.get_text(separator='\n').strip()
                        date_str = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                        country_name = group_id.split(' ')[0]
                        service_div = card.find('div', class_='col-sm-4')
                        service_div_text = service_div.text if service_div else ""
                        service = detect_service(sms_text, service_div_text)
                        code_match = re.search(r'(\d{3}-\d{3})', sms_text) or re.search(r'\b(\d{4,8})\b', sms_text)
                        code = code_match.group(1) if code_match else "N/A"
                        unique_id = f"{phone_number}-{sms_text}"
                        flag = COUNTRY_FLAGS.get(country_name, "üè¥‚Äç‚ò†Ô∏è")

                        all_messages.append({
                            "id": unique_id, "time": date_str, "number": phone_number, "country": country_name,
                            "flag": flag, "service": service, "code": code, "full_sms": sms_text
                        })
        if all_messages:
            print(f"‚úÖ‚úÖ‚úÖ ‡¶ö‡ßÇ‡ßú‡¶æ‡¶®‡ßç‡¶§ ‡¶ß‡¶æ‡¶™ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®‡•§ ‡¶Æ‡ßã‡¶ü {len(all_messages)} ‡¶ü‡¶ø ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶∞‡ßç‡¶∏ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§")
        return all_messages
    except Exception as e:
        print(f"‚ùå API ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ü‡¶®‡¶§‡ßá ‡¶¨‡¶æ ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: {e}")
        traceback.print_exc()
        return []

def login_and_process():
    headers = {'User-Agent': 'Mozilla/5.0'}
    with requests.Session() as session:
        try:
            print("‚ÑπÔ∏è ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...")
            login_data = {'email': USERNAME, 'password': PASSWORD}
            login_page_res = session.get(LOGIN_URL, headers=headers)
            soup = BeautifulSoup(login_page_res.text, 'html.parser')
            token_input = soup.find('input', {'name': '_token'})
            if token_input: login_data['_token'] = token_input['value']
            login_res = session.post(LOGIN_URL, data=login_data, headers=headers)
            login_res.raise_for_status()
            if "login" in login_res.url:
                print("‚ùå ‡¶≤‡¶ó‡¶á‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ/‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§")
                return
            print("‚úÖ ‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá!")
            dashboard_soup = BeautifulSoup(login_res.text, 'html.parser')
            new_token_meta = dashboard_soup.find('meta', {'name': 'csrf-token'})
            new_token_input = dashboard_soup.find('input', {'name': '_token'})
            csrf_token = new_token_meta.get('content') if new_token_meta else new_token_input.get('value') if new_token_input else None
            if not csrf_token:
                print("‚ùå ‡¶®‡¶§‡ßÅ‡¶® CSRF ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§")
                return
            headers['Referer'] = login_res.url
            messages = fetch_sms_from_api(session, headers, csrf_token)
            if not messages: return
            processed_ids = load_processed_ids()
            new_messages_found = 0
            for msg in reversed(messages):
                if msg["id"] not in processed_ids:
                    new_messages_found += 1
                    print(f"‚úîÔ∏è ‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá: {msg['number']} ‡¶•‡ßá‡¶ï‡ßá‡•§")
                    for chat_id in YOUR_CHAT_IDS:
                        asyncio.run(send_telegram_message(YOUR_BOT_TOKEN, chat_id, msg))
                    save_processed_id(msg["id"])
            if new_messages_found > 0:
                print(f"‚úÖ ‡¶Æ‡ßã‡¶ü {new_messages_found} ‡¶ü‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§")
        except Exception as e:
            print(f"‚ùå ‡¶Æ‡ßÇ‡¶≤ ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá: {e}")
            traceback.print_exc()

def main_loop():
    while True:
        print(f"\n--- [{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] ‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ---")
        login_and_process()
        print(f"--- ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶ö‡ßá‡¶ï‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø {POLLING_INTERVAL_SECONDS} ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ---")
        time.sleep(POLLING_INTERVAL_SECONDS)

if __name__ == "__main__":
    print("üöÄ iVasms to Telegram Bot ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...")
    print(f"üöÄ ‡¶™‡ßç‡¶∞‡¶§‡¶ø {POLLING_INTERVAL_SECONDS} ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞ ‡¶™‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá‡•§")
    print("‚ö†Ô∏è ‡¶¨‡¶ü ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶§‡ßá Ctrl+C ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®‡•§")
    main_loop()
